<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Administrator's guide - SmartWalk Docs</title>
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Administrator's guide";
    var mkdocs_page_input_path = "adm.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script>
  <script src="js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="." class="icon icon-home"> SmartWalk Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="index.html">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="usr.html">User's documentation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="prg.html">Programmer's guide</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="adm.html">Administrator's guide</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-preparation">Data preparation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#routing-engine">Routing engine</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#entity-store-and-index">Entity store and index</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#incremental-updates">Incremental updates</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dumping-database">Dumping database</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#restoring-database">Restoring database</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#running-the-app">Running the app</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#development-environment">Development environment</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#database">Database</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#routing-engine_1">Routing engine</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#backend">Backend</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#frontend">Frontend</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#production-environment">Production environment</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href=".">SmartWalk Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".">Docs</a> &raquo;</li>
    
      
    
    <li>Administrator's guide</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/zhukovdm/smartwalk-docs/edit/master/docs/adm.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="administrators-guide">Administrator's guide</h1>
<p><a href="#data-preparation"><strong>Data preparation</strong></a> provides a step-by-step procedure on how to integrate data from <em>six</em> different sources and prepare it for running SmartWalk.</p>
<p>Once data is ready, read <a href="#running-the-app"><strong>Running the app</strong></a> to learn how to get the application up and running in development and production settings.</p>
<p>If something is not working as expected, you might find <a href="#troubleshooting"><strong>Troubleshooting</strong></a> helpful before searching for a solution on the Web.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>SmartWalk is essentially cross-platform. However, Unix utilities simplify certain aspects of system maintenance. We assume that the application will run on <em>Unix-like</em> environments, such as Linux or <a href="https://learn.microsoft.com/en-us/windows/wsl/about">Windows Subsystem for Linux</a>.</p>
<p>Please ensure that the following programs are installed on the target system:</p>
<ul>
<li>Docker</li>
<li>.NET SDK v6.0</li>
<li>Git</li>
<li>GNU Bash, Make, Tar, and Wget</li>
<li>Node.js v18.x (install via <a href="https://github.com/nvm-sh/nvm#install--update-script">nvm</a>)</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If mentioned, preserve versions of packages due to library dependencies.</p>
</div>
<p>Clone the repository with <em>submodules</em> and navigate to its root folder:</p>
<pre><code class="language-bash">$ git clone --recurse-submodules https://github.com/zhukovdm/smartwalk.git
$ cd ./smartwalk/
</code></pre>
<p><strong>ADVICE:</strong> Docker-related commands require the current user to be a member of the <code>docker</code> group to avoid using <code>sudo</code> (or similar) repeatedly. See details at <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">Manage Docker as a non-root user</a>.</p>
<h2 id="data-preparation">Data preparation</h2>
<p>This section explains how to prepare data for two system components: the <a href="#entity-store-and-index"><strong>Database</strong></a> (entity store and index) and the <a href="#routing-engine"><strong>Routing engine</strong></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The complexity of extracting and building data structures depends on the size of a particular region and might be time- and resource-consuming, especially when processing <code>OSM</code> dumps.</p>
</div>
<h3 id="initialization">Initialization</h3>
<p>Navigate to the <code>data</code> folder, assuming you are in the root folder of the <code>smartwalk</code> repository:</p>
<pre><code class="language-bash">$ cd ./data/
</code></pre>
<p>Decide which part of the world you are interested in. Download the corresponding <code>pbf</code>-file at <a href="https://download.geofabrik.de/">Geofabrik</a>, and store it in the <code>./assets/osm-maps/</code> folder. As an example, the following command makes use of the <code>wget</code> utility to obtain the latest dump of the Czech Republic:</p>
<pre><code class="language-bash">$ wget \
    -O ./assets/osm-maps/czech-republic-latest.osm.pbf \
    https://download.geofabrik.de/europe/czech-republic-latest.osm.pbf
</code></pre>
<p>Open <code>Makefile</code> and set the value of <code>REGION_FILE</code> accordingly. Some of the <code>OSM</code> dumps are quite large and additional refinement might be necessary. There are four variables <code>REGION_X</code>, where suffix <code>X</code> can be any of <code>W</code> (West), <code>N</code> (North), <code>E</code> (East), or <code>S</code> (South), defining a bounding box. Entities outside this box are filtered out. To switch off filtering, set <code>W=-180.0</code>, <code>N=85.06</code>, <code>E=180.0</code>, and <code>S=-85.06</code> (see <a href="https://epsg.io/3857">EPSG3857</a> for details).</p>
<p>Create folders for storing data, and restore project dependencies:</p>
<pre><code class="language-bash">$ make init
</code></pre>
<h3 id="routing-engine">Routing engine</h3>
<p>Build a data structure for the routing engine:</p>
<pre><code class="language-bash">$ make routing-engine
</code></pre>
<p>The command pulls <a href="https://hub.docker.com/r/osrm/osrm-backend/">this Docker image</a> and builds the search structure in several consecutive phases. The results are stored in the <code>./assets/routing-engine/</code> folder.</p>
<p><strong>ADVICE:</strong> An instance of OSRM backend is able to load <a href="https://help.openstreetmap.org/questions/64867/osrm-routed-for-multiple-countries">only one</a> <code>osrm</code>-file at a time. This limitation can be overcome via merging (see <a href="https://gis.stackexchange.com/a/242880">osmosis</a>).</p>
<p><strong>ADVICE:</strong> It is possible to extract routing data for several regions and keep all files in the same folder as long as the original <code>pbf</code>-files have distinct names. Use <a href="#environment-variables">environment variables</a> to select a part of the world on engine start.</p>
<h3 id="entity-store-and-index">Entity store and index</h3>
<p>Start up a <a href="https://hub.docker.com/_/mongo/">containerized</a> database instance:</p>
<pre><code class="language-bash">$ docker compose up -d
</code></pre>
<p><strong>ADVICE:</strong> Enter <code>docker container ls</code> repeatedly to print out the list of existing containers. Wait until <code>smartwalk-database</code> is healthy.</p>
<p>Clean up all previous data, create new collections and indexes:</p>
<pre><code class="language-bash">$ make database-init
</code></pre>
<p>Obtain the most popular <code>OSM</code> keys from <a href="https://taginfo.openstreetmap.org/taginfo/apidoc">Taginfo</a> and store results in the <code>./assets/taginfo/</code> folder:</p>
<pre><code class="language-bash">$ make taginfo
</code></pre>
<p><strong>ADVICE:</strong> A list of tags can be extended by altering <code>Makefile</code>, although this is not enough to enable their full potential. The <a href="https://github.com/zhukovdm/smartwalk/blob/fab346ac73f43be063b7e16d4f2c5f060e38ecfc/data/osm/KeywordExtractor.cs#L23-L53">constructor</a> of <code>KeywordExtractor</code> shall reflect changes as well. <u>Never remove</u> tags from the list as it may brake things unexpectedly. Modifying tag list is not a typical operation and may require deeper knowledge of the system.</p>
<p>Extract entities from the <code>pbf</code>-file:</p>
<pre><code class="language-bash">$ make database-osm
</code></pre>
<p>As part of the procedure, the routine makes several <code>GET</code> requests to the <a href="https://overpass-api.de/api/interpreter">Overpass API</a>. A query is configured to time out after 100 seconds, though the server usually responds within the first 10.</p>
<p><strong>ADVICE:</strong> To make queries feasible for the Overpass API, the selected bounding box is divided into smaller pieces. The recipe has two switches <code>--rows</code> and <code>--cols</code> defining the grid.</p>
<p>Create stubs for new entities from the <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">Wikidata</a> knowledge graph:</p>
<pre><code class="language-bash">$ make database-wikidata-create
</code></pre>
<p>The script attempts to fetch data from a SPARQL endpoint. Requests may time out after <em>one</em> minute. Large regions are more likely to result in failures. Hence, the numeric constants were specifically chosen for the test setup and may not be suitable for other cases.</p>
<p><strong>ADVICE:</strong> The recipe has <code>--rows</code> and <code>--cols</code> switches with functionality similar to <code>database-osm</code>.</p>
<p>Enrich the current dataset with information from <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">Wikidata</a>:</p>
<pre><code class="language-bash">$ make database-wikidata-enrich
</code></pre>
<p>Enrich the current dataset with information from the <a href="https://www.dbpedia.org/about/">DBPedia</a> knowledge graph:</p>
<pre><code class="language-bash">$ make database-dbpedia
</code></pre>
<p>Collect supporting data to aid autocomplete functionality:</p>
<pre><code class="language-bash">$ make advice
</code></pre>
<p>Finally, stop the database instance:</p>
<pre><code class="language-bash">$ docker compose down
</code></pre>
<p>All relevant files are stored in the <code>./assets/database/</code> folder.</p>
<h3 id="incremental-updates">Incremental updates</h3>
<p>The system supports incremental updates to incorporate new versions of datasets. It is possible to re-run blue-highlighted commands with no impact on data integrity. The programs are designed to update only defined properties without replacing entities, acting as an <a href="https://en.wikipedia.org/wiki/Idempotence#Idempotent_functions">idempotent</a> function.</p>
<p><code>advice</code> should be re-generated whenever the database state is altered.</p>
<p><img alt="step dependencies" src="img/data-prep-deps.svg" /></p>
<h3 id="dumping-database">Dumping database</h3>
<p>Dump the current database state:</p>
<pre><code class="language-bash">$ make dump
</code></pre>
<p>The command creates <code>keyword.txt</code> and <code>place.txt</code> in the <code>./assets/dump/</code> folder.</p>
<p>If necessary, archive these files for publishing:</p>
<pre><code class="language-bash">$ cd ./assets/dump/
$ tar -czf smartwalk-[kind]-[timestamp].tar.gz *.txt
</code></pre>
<h3 id="restoring-database">Restoring database</h3>
<p>Ensure that a database container is up and running, see <a href="#entity-store-and-index"><strong>Entity store and index</strong></a> for more details. Clean up the database and restore the state from files:</p>
<pre><code class="language-bash">$ make init &amp;&amp; make database-init &amp;&amp; make restore
</code></pre>
<p>The <code>restore</code> procedure expects <code>keyword.txt</code> and <code>place.txt</code> to be in the <code>./assets/dump/</code> folder. Otherwise, it fails.</p>
<p>Examples of archived dumps can be found <a href="https://www.dropbox.com/scl/fo/phyv4l2649p3oqy4345wp/h?rlkey=jbg9obkzk6izoy8vlulveznq9&amp;dl=0">here</a>. Those having <code>prod</code> in their names are the most data-rich covering beautiful <a href="https://en.wikipedia.org/wiki/Prague">Prague</a>.</p>
<p>If necessary, unpack a downloaded archive as follows:</p>
<pre><code class="language-bash">$ cd ./assets/dump/
$ tar -xzf smartwalk-[kind]-[timestamp].tar.gz
</code></pre>
<h2 id="running-the-app">Running the app</h2>
<p>The purpose of this section is to explain how to start the system in development and production modes. We assume that you are in the root folder of the <code>smartwalk</code> repository and all relevant data have been extracted or restored and are available in their respective folders.</p>
<h3 id="development-environment">Development environment</h3>
<p>This environment is intended primarily for developers and testers. It enables controlling parts of the system independently.</p>
<p>There are <em>four</em> system components involved in the setup: the frontend, backend, database, and routing engine. The first two run directly in the terminal, while the last two are Docker containers. The table below summarizes their roles and the mapping of system ports.</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Ports</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>localhost:27017</td>
<td>Entity store and index</td>
</tr>
<tr>
<td>routing</td>
<td>localhost:5000</td>
<td>Routing engine</td>
</tr>
<tr>
<td>backend</td>
<td>localhost:5017</td>
<td>Application logic <s>(hot reload)</s></td>
</tr>
<tr>
<td>frontend</td>
<td>localhost:3000</td>
<td>Static files (hot reload)</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For convenience, components can be started and stopped directly from the <code>smartwalk</code> root folder. Please refer to <a href="https://github.com/zhukovdm/smartwalk/blob/main/Makefile">Makefile</a>. Recipe names follow the pattern <code>[component_name]-dev[-stop]</code>.</p>
</div>
<h4 id="database">Database</h4>
<p>Start and stop an instance of database using <code>database-dev[-stop]</code> from <code>Makefile</code>.</p>
<h4 id="routing-engine_1">Routing engine</h4>
<p>Start and stop an instance of routing engine using <code>routing-dev[-stop]</code> from <code>Makefile</code>.</p>
<p>Set <code>OSRM_REGION_FILE</code> in <a href="https://github.com/zhukovdm/smartwalk/blob/main/infra/.env.development">.env.development</a> to load a region other than the Czech Republic.</p>
<h4 id="backend">Backend</h4>
<p>The project is located in <code>./app/backend/</code>. Run <code>dotnet run</code> from there to start the backend in the terminal, and stop it by pressing <code>Ctrl+C</code>. Read more about other commands in <a href="https://github.com/zhukovdm/smartwalk/blob/main/app/backend/README.md">README.md</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This component requires the <code>database</code> to be up and running. Otherwise, it fails to start.</p>
</div>
<p>The source code uses <code>SMARTWALK_MONGO_CONN_STR</code> and <code>SMARTWALK_OSRM_BASE_URL</code> environment variables. Adjust <a href="https://github.com/zhukovdm/smartwalk/blob/main/app/backend/SmartWalk.Api/Properties/launchSettings.json">launchSettings.json</a> respectively if you wish to alter the default port configuration.</p>
<h4 id="frontend">Frontend</h4>
<p>Find the project in <code>./app/frontend/</code>. Run <code>npm start</code> from there to start the frontend in the terminal, and stop it by pressing <code>Ctrl+C</code>. Learn more about other commands in <a href="https://github.com/zhukovdm/smartwalk/blob/main/app/frontend/README.md">README.md</a>.</p>
<p>The source code uses <code>REACT_APP_SMARTWALK_API_ORIGIN</code> environment variable. Set its value in the <a href="https://github.com/zhukovdm/smartwalk/blob/main/app/frontend/.env.development">.env.development</a> file if you wish to run backend on another port.</p>
<h3 id="production-environment">Production environment</h3>
<p>This environment is a tightly coupled bundle consisting of four interconnected Docker containers; its detailed schema is shown in the picture below.</p>
<p><img alt="docker production setup" src="img/docker-production-setup.svg" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>database</code> exposes port <code>27017</code> for manual diagnostic and performance testing. Hide it if none of the mentioned reasons is your case.</p>
</div>
<p>Start and stop production environment from the root folder of the repo:</p>
<pre><code class="language-bash">$ make prod[-stop]
</code></pre>
<p><strong>ADVICE:</strong> All containers implement healthcheck, run <code>docker container ls</code> to see their state.</p>
<p>The respective environment variables are defined in the <a href="https://github.com/zhukovdm/smartwalk/blob/main/infra/.env.production">.env.production</a> file.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p><font size="4"><strong>WSL runs out of memory</strong></font></p>
<p>If your <code>WSL</code> consumes too much memory, Windows might suddenly terminate the entire process without prior notice. Try to mitigate the issue by extending the swap file; set <code>swap=XXGB</code> in the <code>.wslconfig</code> file. For more details, see <a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#example-wslconfig-file">Example .wslconfig file</a>.</p>
<p><font size="4"><strong>A container starts for too long</strong></font></p>
<p>If any of the containers is unhealthy or starting for too long (healthcheck has failed repeatedly on the background), replace <code>[container_name]</code> placeholder by the name of a problematic instance and press <code>Enter</code> to find out the reason:</p>
<pre><code class="language-bash">$ docker container ls -a

CONTAINER ID   IMAGE                    ...   NAMES
...            ...                      ...   ...
377fe35d4472   smartwalk/proxy:v1.0.0   ...   smartwalk-proxy
...            ...                      ...   ...

$ docker inspect --format &quot;{{json .State.Health }}&quot; [container_name]
</code></pre>
<p><font size="4"><strong>Nothing seems to help</strong></font></p>
<p>If the system does not work properly and you do not know what to do, clean up files and start from scratch. As the first step, remove <em>SmartWalk</em> images:</p>
<pre><code class="language-bash">$ docker image rm smartwalk/proxy
$ docker image rm smartwalk/backend
$ docker image rm smartwalk/routing
</code></pre>
<p>Clean up unused Docker files (cached build files, dangling images and volumes, etc.):</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Use this command with caution as it may introduce undesired changes into your Docker host. Read about side effects <a href="https://docs.docker.com/engine/reference/commandline/system_prune/">here</a>.</p>
</div>
<pre><code class="language-bash">$ docker system prune --volumes
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="prg.html" class="btn btn-neutral" title="Programmer's guide"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/zhukovdm/smartwalk-docs/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="prg.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme.js" defer></script>
      <script src="js/extra.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
